---
import Base from '../layouts/Base.astro';
import {
  getEvents,
  getCities,
  getTraditions,
  getEventTypes,
  formatDateRange,
  formatLocation,
  EventType,
  EventTypeLabels,
  EventStatus,
  EventStatusLabels,
  TraditionCategory,
  TraditionCategoryLabels,
  MUSIC_TRADITIONS,
  REGIONS
} from '../lib/api';

const url = Astro.url;

// Get all filter params
const cityFilter = url.searchParams.get('city');
const regionFilter = url.searchParams.get('region');
const traditionFilter = url.searchParams.get('tradition');
const typeFilter = url.searchParams.get('type') as EventType | null;
const categoryFilter = url.searchParams.get('category') as TraditionCategory | null;
const statusFilter = url.searchParams.get('status') as EventStatus | null;
const seasonFilter = url.searchParams.get('season');
const query = url.searchParams.get('q');

let events = getEvents();
const cities = getCities();
const traditions = getTraditions();
const eventTypes = getEventTypes();

// Apply filters (reusing existing logic from events/index.astro)
if (cityFilter) {
  events = events.filter(e => e.location.city_slug === cityFilter);
}

if (regionFilter) {
  events = events.filter(e => e.location.region_slug === regionFilter);
}

if (traditionFilter) {
  events = events.filter(e => e.traditions.includes(traditionFilter));
}

if (typeFilter) {
  events = events.filter(e => e.event_type === typeFilter);
}

if (categoryFilter) {
  events = events.filter(e =>
    e.traditions.some(tid => {
      const tradition = MUSIC_TRADITIONS[tid];
      return tradition && tradition.category === categoryFilter;
    })
  );
}

if (statusFilter) {
  events = events.filter(e => e.status === statusFilter);
}

if (seasonFilter) {
  events = events.filter(e => e.timing.season === seasonFilter);
}

if (query) {
  const q = query.toLowerCase();
  events = events.filter(e =>
    e.name.toLowerCase().includes(q) ||
    (e.location.city && e.location.city.toLowerCase().includes(q)) ||
    e.location.region.toLowerCase().includes(q) ||
    e.traditions.some(tid => {
      const tradition = MUSIC_TRADITIONS[tid];
      return tradition && tradition.name.toLowerCase().includes(q);
    }) ||
    e.artists.some(a => a.toLowerCase().includes(q))
  );
}

// Sort by cultural weight then date (same as events page)
events.sort((a, b) => {
  if (a.is_featured && !b.is_featured) return -1;
  if (!a.is_featured && b.is_featured) return 1;
  if (a.cultural_weight !== b.cultural_weight) return b.cultural_weight - a.cultural_weight;
  return (a.timing.gregorian_start || '').localeCompare(b.timing.gregorian_start || '');
});

// Group traditions by category for the filter
const rootedTraditions = traditions.filter(t => t.category === TraditionCategory.ROOTED);
const hybridTraditions = traditions.filter(t => t.category === TraditionCategory.HYBRID);
const importedTraditions = traditions.filter(t => t.category === TraditionCategory.IMPORTED);

// Active statuses for filter
const activeStatuses = [
  EventStatus.CONFIRMED,
  EventStatus.ANNOUNCED,
  EventStatus.TENTATIVE
];

const hasFilters = cityFilter || regionFilter || traditionFilter || typeFilter || categoryFilter || statusFilter || seasonFilter || query;
---

<Base title="Advanced Search - Festivals in Morocco">
  <div class="search-layout">
    <aside class="filters-panel">
      <div class="filters-header">
        <span class="filters-title">Filters</span>
        {hasFilters && <a href="/search" class="clear-all">Clear all</a>}
      </div>

      <form method="GET" action="/search" id="search-form">
        <div class="filter-group">
          <label for="q">Search</label>
          <input type="search" name="q" id="q" value={query || ''} placeholder="Event, artist, place..." />
        </div>

        <div class="filter-group">
          <label for="type">Event Type</label>
          <select name="type" id="type">
            <option value="">All Types</option>
            {eventTypes.map(et => (
              <option value={et.type} selected={typeFilter === et.type}>
                {et.label} ({et.count})
              </option>
            ))}
          </select>
        </div>

        <div class="filter-group">
          <label for="category">Tradition Category</label>
          <select name="category" id="category">
            <option value="">All Categories</option>
            <option value={TraditionCategory.ROOTED} selected={categoryFilter === TraditionCategory.ROOTED}>
              Rooted Traditions
            </option>
            <option value={TraditionCategory.HYBRID} selected={categoryFilter === TraditionCategory.HYBRID}>
              Hybrid / Contemporary
            </option>
            <option value={TraditionCategory.IMPORTED} selected={categoryFilter === TraditionCategory.IMPORTED}>
              International
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label for="tradition">Tradition</label>
          <select name="tradition" id="tradition">
            <option value="">All Traditions</option>
            {rootedTraditions.length > 0 && (
              <optgroup label="Rooted">
                {rootedTraditions.map(t => (
                  <option value={t.id} selected={traditionFilter === t.id}>
                    {t.name} {t.sacred ? '●' : ''} ({t.count})
                  </option>
                ))}
              </optgroup>
            )}
            {hybridTraditions.length > 0 && (
              <optgroup label="Hybrid">
                {hybridTraditions.map(t => (
                  <option value={t.id} selected={traditionFilter === t.id}>
                    {t.name} ({t.count})
                  </option>
                ))}
              </optgroup>
            )}
            {importedTraditions.length > 0 && (
              <optgroup label="International">
                {importedTraditions.map(t => (
                  <option value={t.id} selected={traditionFilter === t.id}>
                    {t.name} ({t.count})
                  </option>
                ))}
              </optgroup>
            )}
          </select>
        </div>

        <div class="filter-group">
          <label for="region">Region</label>
          <select name="region" id="region">
            <option value="">All Regions</option>
            {REGIONS.map(r => (
              <option value={r.slug} selected={regionFilter === r.slug}>
                {r.name}
              </option>
            ))}
          </select>
        </div>

        <div class="filter-group">
          <label for="city">City</label>
          <select name="city" id="city">
            <option value="">All Cities</option>
            {cities.map(city => (
              <option value={city.slug} selected={cityFilter === city.slug}>
                {city.name} ({city.count})
              </option>
            ))}
          </select>
        </div>

        <div class="filter-group">
          <label for="season">Season</label>
          <select name="season" id="season">
            <option value="">All Seasons</option>
            <option value="spring" selected={seasonFilter === 'spring'}>Spring</option>
            <option value="summer" selected={seasonFilter === 'summer'}>Summer</option>
            <option value="autumn" selected={seasonFilter === 'autumn'}>Autumn</option>
            <option value="winter" selected={seasonFilter === 'winter'}>Winter</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="status">Status</label>
          <select name="status" id="status">
            <option value="">All Statuses</option>
            {activeStatuses.map(s => (
              <option value={s} selected={statusFilter === s}>
                {EventStatusLabels[s]}
              </option>
            ))}
          </select>
        </div>

        <button type="submit" class="apply-btn">Apply Filters</button>
      </form>

      <div class="map-link">
        <a href="/map">View on map</a>
      </div>
    </aside>

    <main class="results-panel">
      <div class="results-header">
        <span class="results-count">{events.length} result{events.length !== 1 ? 's' : ''}</span>
      </div>

      {events.length > 0 ? (
        <div class="events-grid">
          {events.map(event => {
            const eventTraditions = event.traditions
              .map(tid => MUSIC_TRADITIONS[tid])
              .filter(Boolean);
            const hasSacred = eventTraditions.some(t => t.sacred);

            return (
              <a href={`/events/${event.slug}`} class="event-card" data-weight={event.cultural_weight}>
                <div class="event-header">
                  <span class="event-date">{formatDateRange(event.timing)}</span>
                  <div class="event-badges">
                    {event.is_verified && <span class="verified" title="Verified">✓</span>}
                    {hasSacred && <span class="sacred" title="Features sacred tradition">◆</span>}
                  </div>
                </div>

                <h2>{event.name}</h2>
                <p class="event-location">{formatLocation(event.location)}</p>

                <div class="event-traditions">
                  {eventTraditions.slice(0, 3).map(tradition => (
                    <span
                      class="tradition-tag"
                      data-category={tradition.category}
                      data-sacred={tradition.sacred}
                    >
                      {tradition.name}
                    </span>
                  ))}
                  {eventTraditions.length > 3 && (
                    <span class="tradition-more">+{eventTraditions.length - 3}</span>
                  )}
                </div>

                <div class="event-footer">
                  <span class="event-type">{EventTypeLabels[event.event_type]}</span>
                  <span class="event-status" data-status={event.status}>{event.status}</span>
                </div>
              </a>
            );
          })}
        </div>
      ) : (
        <div class="no-results">
          <p>No events match your criteria.</p>
          <a href="/search">Clear filters</a>
        </div>
      )}
    </main>
  </div>
</Base>

<script>
  const form = document.getElementById('search-form') as HTMLFormElement;
  const selects = form.querySelectorAll('select');

  selects.forEach(select => {
    select.addEventListener('change', () => form.submit());
  });
</script>

<style>
  .search-layout {
    display: grid;
    grid-template-columns: 280px 1fr;
    gap: 2rem;
    min-height: calc(100vh - 200px);
  }

  .filters-panel {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    height: fit-content;
    position: sticky;
    top: 80px;
  }

  .filters-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.25rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid var(--border);
  }

  .filters-title {
    font-weight: 600;
    font-size: 0.9rem;
  }

  .clear-all {
    font-size: 0.75rem;
    color: var(--accent);
  }

  .filter-group {
    margin-bottom: 1rem;
  }

  .filter-group label {
    display: block;
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-muted);
    margin-bottom: 0.375rem;
    text-transform: uppercase;
    letter-spacing: 0.025em;
  }

  .filter-group input,
  .filter-group select {
    width: 100%;
    padding: 0.5rem 0.75rem;
    border: 1px solid var(--border);
    border-radius: 6px;
    background: var(--bg);
    color: var(--text);
    font-size: 0.875rem;
  }

  .filter-group input:focus,
  .filter-group select:focus {
    outline: none;
    border-color: var(--accent);
  }

  .apply-btn {
    width: 100%;
    padding: 0.625rem;
    background: var(--accent);
    color: var(--accent-contrast);
    border: none;
    border-radius: 6px;
    font-size: 0.875rem;
    font-weight: 500;
    cursor: pointer;
    margin-top: 0.5rem;
  }

  .apply-btn:hover {
    background: var(--accent-hover);
  }

  .map-link {
    margin-top: 1.25rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border);
    text-align: center;
  }

  .map-link a {
    font-size: 0.8rem;
    color: var(--text-muted);
  }

  .map-link a:hover {
    color: var(--accent);
  }

  .results-panel {
    min-width: 0;
  }

  .results-header {
    margin-bottom: 1rem;
  }

  .results-count {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .events-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
  }

  /* Event card styles - reused from events/index.astro */
  .event-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1.25rem;
    transition: border-color 0.2s;
  }

  .event-card:hover {
    border-color: var(--accent);
  }

  .event-card[data-weight="4"],
  .event-card[data-weight="5"] {
    border-left: 3px solid var(--accent);
  }

  .event-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
  }

  .event-date {
    color: var(--accent);
    font-size: 0.8rem;
    font-weight: 500;
  }

  .event-badges {
    display: flex;
    gap: 0.25rem;
  }

  .verified {
    background: var(--accent);
    color: var(--accent-contrast);
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.65rem;
  }

  .sacred {
    background: var(--sacred);
    color: var(--accent-contrast);
    width: 18px;
    height: 18px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.55rem;
  }

  .event-card h2 {
    font-size: 1.1rem;
    font-weight: 600;
    margin-bottom: 0.375rem;
    line-height: 1.3;
  }

  .event-location {
    color: var(--text-muted);
    font-size: 0.85rem;
    margin-bottom: 0.625rem;
  }

  .event-traditions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin-bottom: 0.75rem;
  }

  .tradition-tag {
    padding: 0.2rem 0.5rem;
    border-radius: 100px;
    font-size: 0.7rem;
  }

  .tradition-tag[data-category="rooted"] {
    background: var(--category-rooted-bg);
    color: var(--category-rooted);
  }

  .tradition-tag[data-category="hybrid"] {
    background: var(--category-hybrid-bg);
    color: var(--category-hybrid);
  }

  .tradition-tag[data-category="imported"] {
    background: var(--category-imported-bg);
    color: var(--category-imported);
  }

  .tradition-tag[data-sacred="true"] {
    border: 1px solid var(--sacred);
  }

  .tradition-more {
    padding: 0.2rem 0.375rem;
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .event-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.625rem;
    border-top: 1px solid var(--border);
  }

  .event-type {
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .event-status {
    font-size: 0.7rem;
    padding: 0.15rem 0.4rem;
    border-radius: 4px;
    text-transform: capitalize;
  }

  .event-status[data-status="confirmed"] {
    background: var(--status-confirmed-bg);
    color: var(--status-confirmed);
  }

  .event-status[data-status="announced"] {
    background: var(--status-announced-bg);
    color: var(--status-announced);
  }

  .event-status[data-status="tentative"] {
    background: var(--status-tentative-bg);
    color: var(--status-tentative);
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    color: var(--text-muted);
  }

  .no-results a {
    display: inline-block;
    margin-top: 0.75rem;
    color: var(--accent);
    font-size: 0.875rem;
  }

  @media (max-width: 768px) {
    .search-layout {
      grid-template-columns: 1fr;
    }

    .filters-panel {
      position: static;
    }

    .events-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
