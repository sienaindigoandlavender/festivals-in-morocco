---
import Base from '../layouts/Base.astro';
import { getSheetEvents, type SheetEvent } from '../lib/supabase';
import { CITY_COORDINATES, MOROCCO_REGIONS_GEOJSON, MOROCCO_BOUNDS } from '../lib/geo';

const sheetEvents = await getSheetEvents();

// Map sheet events to the format the map expects
const events = sheetEvents.map(e => ({
  id: e.slug,
  name: e.title_en,
  slug: e.slug,
  event_type: e.category,
  traditions: e.tags,
  timing: {
    gregorian_start: e.startDate,
    gregorian_end: e.endDate
  },
  location: {
    city: e.city,
    city_slug: e.city?.toLowerCase().replace(/\s+/g, '-').replace(/'/g, ''),
    region: e.region,
    region_slug: e.region?.toLowerCase().replace(/\s+/g, '-'),
    area_description: e.venue,
    location_type: 'city'
  }
}));

// Helper to format date range
function formatDateRange(timing: { gregorian_start?: string; gregorian_end?: string }): string {
  if (!timing.gregorian_start) return 'Date TBC';
  const start = new Date(timing.gregorian_start);
  const startStr = start.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  if (!timing.gregorian_end || timing.gregorian_end === timing.gregorian_start) return startStr;
  const end = new Date(timing.gregorian_end);
  const endStr = end.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
  return `${startStr} – ${endStr}`;
}

// Group events by city
const eventsByCity = new Map<string, typeof events>();
const eventsWithoutCity: typeof events = [];

for (const event of events) {
  if (event.location.city_slug) {
    if (!eventsByCity.has(event.location.city_slug)) {
      eventsByCity.set(event.location.city_slug, []);
    }
    eventsByCity.get(event.location.city_slug)!.push(event);
  } else {
    eventsWithoutCity.push(event);
  }
}

// Build city stats with numeric references
const cityStats = Array.from(eventsByCity.entries()).map(([slug, cityEvents]) => {
  const firstEvent = cityEvents[0];
  return {
    slug,
    name: firstEvent.location.city!,
    region: firstEvent.location.region,
    regionSlug: firstEvent.location.region_slug,
    count: cityEvents.length
  };
}).sort((a, b) => b.count - a.count).map((city, index) => ({
  ...city,
  ref: index + 1
}));

// Serialize data for client-side
const clientData = {
  events: events.map(e => ({
    id: e.id,
    name: e.name,
    slug: e.slug,
    eventType: e.event_type,
    eventTypeLabel: e.event_type,
    traditions: e.traditions,
    dateRange: formatDateRange(e.timing),
    regionSlug: e.location.region_slug,
    region: e.location.region,
    citySlug: e.location.city_slug || null,
    city: e.location.city || null,
    areaDescription: e.location.area_description || null,
    locationType: e.location.location_type
  })),
  cityStats,
  ruralCount: eventsWithoutCity.length,
  cityCoordinates: CITY_COORDINATES,
  regionsGeoJSON: MOROCCO_REGIONS_GEOJSON,
  bounds: MOROCCO_BOUNDS
};
---

<Base title="Map - Festivals in Morocco">
  <div class="map-container">
    <div id="map"></div>
    <aside class="map-sidebar" id="sidebar">
      <div class="sidebar-header">
        <h2 id="sidebar-title">Morocco</h2>
        <p id="sidebar-subtitle">{events.length} events in {cityStats.length} cities</p>
      </div>
      <div class="sidebar-content" id="sidebar-content">
        <div class="city-list" id="city-list">
          {cityStats.map(city => (
            <button class="city-item" data-city={city.slug}>
              <span class="city-ref">{city.ref}</span>
              <div class="city-info">
                <span class="city-name">{city.name}</span>
                <span class="city-region">{city.region}</span>
              </div>
              <span class="city-count">{city.count}</span>
            </button>
          ))}
          {eventsWithoutCity.length > 0 && (
            <button class="city-item rural-item" data-city="__rural__">
              <span class="city-ref rural-ref">&mdash;</span>
              <div class="city-info">
                <span class="city-name">Rural / Other</span>
                <span class="city-region">Various locations</span>
              </div>
              <span class="city-count">{eventsWithoutCity.length}</span>
            </button>
          )}
        </div>
      </div>
      <div class="sidebar-events" id="sidebar-events" style="display: none;">
        <div class="events-list" id="events-list"></div>
      </div>
      <button class="back-button" id="back-button" style="display: none;">
        &larr; All cities
      </button>
    </aside>
  </div>
</Base>

<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet">
<script is:inline src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>

<script define:vars={{ clientData }}>
  const MAPBOX_TOKEN = import.meta.env.PUBLIC_MAPBOX_TOKEN || '';

  mapboxgl.accessToken = MAPBOX_TOKEN;

  const map = new mapboxgl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: {},
      layers: [
        {
          id: 'background',
          type: 'background',
          paint: { 'background-color': '#F7F5F2' }
        }
      ]
    },
    center: [-6.5, 31.5],
    zoom: 4.5,
    minZoom: 4,
    maxZoom: 10,
    maxBounds: [[-20, 18], [5, 38]]
  });

  let selectedCity = null;
  let cityMarkers = [];

  // DOM elements
  const sidebarTitle = document.getElementById('sidebar-title');
  const sidebarSubtitle = document.getElementById('sidebar-subtitle');
  const sidebarContent = document.getElementById('sidebar-content');
  const sidebarEvents = document.getElementById('sidebar-events');
  const eventsList = document.getElementById('events-list');
  const backButton = document.getElementById('back-button');
  const cityList = document.getElementById('city-list');

  map.on('load', () => {
    // Add regions source (for subtle context)
    map.addSource('regions', {
      type: 'geojson',
      data: clientData.regionsGeoJSON
    });

    // Add subtle region fill layer
    map.addLayer({
      id: 'region-fill',
      type: 'fill',
      source: 'regions',
      paint: {
        'fill-color': 'rgba(74, 98, 89, 0.04)',
        'fill-opacity': 1
      }
    });

    // Add region outline layer
    map.addLayer({
      id: 'region-outline',
      type: 'line',
      source: 'regions',
      paint: {
        'line-color': '#E3DFD9',
        'line-width': 1
      }
    });

    // Add all city markers on load
    for (const city of clientData.cityStats) {
      const coords = clientData.cityCoordinates[city.slug];
      if (!coords) continue;

      const el = document.createElement('div');
      el.className = 'city-marker';
      el.textContent = city.ref;
      el.dataset.city = city.slug;
      el.addEventListener('click', (e) => {
        e.stopPropagation();
        selectCity(city.slug);
      });

      const marker = new mapboxgl.Marker({ element: el, anchor: 'center' })
        .setLngLat([coords[1], coords[0]])
        .addTo(map);

      cityMarkers.push({ slug: city.slug, marker });
    }

    // Map click to deselect
    map.on('click', () => {
      if (selectedCity) {
        resetView();
      }
    });
  });

  function selectCity(slug) {
    selectedCity = slug;

    // Highlight city marker
    document.querySelectorAll('.city-marker').forEach(el => {
      el.classList.toggle('selected', el.dataset.city === slug);
    });
    document.querySelectorAll('.city-item').forEach(el => {
      el.classList.toggle('selected', el.dataset.city === slug);
    });

    // Get city info
    const city = clientData.cityStats.find(c => c.slug === slug);
    const isRural = slug === '__rural__';

    // Update sidebar
    if (isRural) {
      sidebarTitle.textContent = 'Rural / Other';
      sidebarSubtitle.textContent = `${clientData.ruralCount} events`;
    } else if (city) {
      sidebarTitle.textContent = city.name;
      sidebarSubtitle.textContent = `${city.count} event${city.count !== 1 ? 's' : ''} · ${city.region}`;
    }

    sidebarContent.style.display = 'none';
    sidebarEvents.style.display = 'block';
    backButton.style.display = 'block';

    // Filter events
    const cityEvents = isRural
      ? clientData.events.filter(e => !e.citySlug)
      : clientData.events.filter(e => e.citySlug === slug);

    renderEventsList(cityEvents, isRural);

    // Zoom to city (if not rural)
    if (!isRural) {
      const coords = clientData.cityCoordinates[slug];
      if (coords) {
        map.flyTo({ center: [coords[1], coords[0]], zoom: 8, duration: 500 });
      }
    }
  }

  function renderEventsList(events, isRural = false) {
    let html = `<div class="events-header">${events.length} Event${events.length !== 1 ? 's' : ''}</div>`;

    for (const event of events) {
      const locationText = isRural
        ? (event.areaDescription || event.region)
        : event.dateRange;

      html += `
        <a href="/events/${event.slug}" class="event-item${isRural ? ' rural' : ''}">
          <div class="event-item-name">${event.name}</div>
          <div class="event-item-meta">
            <span class="event-item-date">${event.dateRange}</span>
            ${isRural ? `<span class="event-item-location">${event.areaDescription || event.region}</span>` : ''}
          </div>
          <div class="event-item-footer">
            <span class="event-item-traditions">${event.traditions.slice(0, 2).join(', ')}</span>
            <span class="event-item-type">${event.eventTypeLabel}</span>
          </div>
        </a>
      `;
    }

    eventsList.innerHTML = html;
  }

  function resetView() {
    selectedCity = null;

    // Reset markers
    document.querySelectorAll('.city-marker').forEach(el => {
      el.classList.remove('selected');
    });
    document.querySelectorAll('.city-item').forEach(el => {
      el.classList.remove('selected');
    });

    // Reset map view
    map.fitBounds([[-17.5, 21], [-1, 36]], { padding: 20, duration: 500 });

    // Reset sidebar
    sidebarTitle.textContent = 'Morocco';
    sidebarSubtitle.textContent = `${clientData.events.length} events in ${clientData.cityStats.length} cities`;
    sidebarContent.style.display = 'block';
    sidebarEvents.style.display = 'none';
    backButton.style.display = 'none';
  }

  // Back button handler
  backButton.addEventListener('click', resetView);

  // City list click handler
  cityList.querySelectorAll('.city-item').forEach(btn => {
    btn.addEventListener('click', () => selectCity(btn.dataset.city));
  });
</script>

<style>
  .map-container {
    display: grid;
    grid-template-columns: 1fr 360px;
    height: calc(100vh - 140px);
    margin: -2rem -1.5rem -4rem;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  .map-sidebar {
    background: var(--bg-card);
    border-left: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }

  .sidebar-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
  }

  .sidebar-header h2 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .sidebar-header p {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .sidebar-content,
  .sidebar-events {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
  }

  .city-list {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .city-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.625rem 0.875rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
    text-align: left;
    width: 100%;
  }

  .city-ref {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    background: var(--accent);
    color: var(--accent-contrast);
    border-radius: 50%;
    font-size: 0.75rem;
    font-weight: 600;
    flex-shrink: 0;
  }

  .city-item:hover {
    border-color: var(--accent);
  }

  .city-item.selected {
    border-color: var(--accent);
    background: var(--category-rooted-bg);
  }

  .city-item.rural-item {
    margin-top: 0.75rem;
    border-style: dashed;
  }

  .rural-ref {
    background: var(--text-muted);
  }

  .city-info {
    display: flex;
    flex-direction: column;
    gap: 0.125rem;
    flex: 1;
    min-width: 0;
  }

  .city-name {
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--text);
  }

  .city-region {
    font-size: 0.7rem;
    color: var(--text-muted);
  }

  .city-count {
    color: var(--text-muted);
    font-size: 0.8rem;
    flex-shrink: 0;
  }

  .events-header {
    font-size: 0.75rem;
    font-weight: 600;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.75rem;
    padding: 0 0.25rem;
  }

  .event-item {
    display: block;
    padding: 0.875rem;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: border-color 0.2s;
  }

  .event-item:hover {
    border-color: var(--accent);
  }

  .event-item.rural {
    border-left: 2px solid var(--text-muted);
  }

  .event-item-name {
    font-weight: 500;
    margin-bottom: 0.375rem;
    line-height: 1.3;
  }

  .event-item-meta {
    display: flex;
    gap: 0.75rem;
    font-size: 0.8rem;
    color: var(--text-muted);
    margin-bottom: 0.5rem;
  }

  .event-item-date {
    color: var(--accent);
  }

  .event-item-footer {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: var(--text-muted);
  }

  .back-button {
    padding: 1rem;
    background: none;
    border: none;
    border-top: 1px solid var(--border);
    color: var(--text-muted);
    font-size: 0.875rem;
    cursor: pointer;
    text-align: left;
    transition: color 0.2s;
  }

  .back-button:hover {
    color: var(--accent);
  }

  /* Map markers */
  :global(.city-marker) {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 26px;
    height: 26px;
    background: var(--accent);
    color: var(--accent-contrast);
    border-radius: 50%;
    font-size: 0.75rem;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.15s, box-shadow 0.15s;
    box-shadow: 0 1px 3px rgba(0,0,0,0.15);
  }

  :global(.city-marker:hover) {
    transform: scale(1.15);
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }

  :global(.city-marker.selected) {
    transform: scale(1.2);
    box-shadow: 0 0 0 3px var(--category-rooted-bg), 0 2px 6px rgba(0,0,0,0.2);
  }

  @media (max-width: 768px) {
    .map-container {
      grid-template-columns: 1fr;
      grid-template-rows: 50vh 1fr;
    }

    .map-sidebar {
      border-left: none;
      border-top: 1px solid var(--border);
    }
  }
</style>
