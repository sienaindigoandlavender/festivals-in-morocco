---
import Base from '../../layouts/Base.astro';
import { getSheetEvents, type SheetEvent } from '../../lib/supabase';
import { getCities } from '../../lib/api';

const url = Astro.url;
const cityFilter = url.searchParams.get('city');
const categoryFilter = url.searchParams.get('category');
const query = url.searchParams.get('q');

let events = await getSheetEvents();
const cities = getCities();

// Apply filters
if (cityFilter) {
  events = events.filter(e => e.city.toLowerCase().replace(/\s+/g, '-') === cityFilter);
}

if (categoryFilter) {
  events = events.filter(e => e.category === categoryFilter);
}

if (query) {
  const q = query.toLowerCase();
  events = events.filter(e =>
    e.title_en.toLowerCase().includes(q) ||
    e.city.toLowerCase().includes(q) ||
    e.region.toLowerCase().includes(q) ||
    e.tags.some(t => t.toLowerCase().includes(q)) ||
    e.description_en.toLowerCase().includes(q)
  );
}

events.sort((a, b) => a.startDate.localeCompare(b.startDate));

const hasFilters = cityFilter || categoryFilter || query;

function formatDate(dateStr: string): { day: string; month: string } {
  const date = new Date(dateStr);
  return {
    day: String(date.getDate()).padStart(2, '0'),
    month: date.toLocaleDateString('en-GB', { month: 'short' }).toUpperCase()
  };
}

const categories = ['festival', 'concert', 'heritage', 'cultural', 'art', 'sports'];
---

<Base title="Events â€” Festivals in Morocco">
  <div class="page-header">
    <span class="micro-label">Archive</span>
    <h1>Events</h1>
    <p class="page-intro">{events.length} cultural events across Morocco</p>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="filter-row">
      <div class="filter-group">
        <label class="micro-label">Category</label>
        <select id="category-filter">
          <option value="">All Categories</option>
          {categories.map(cat => (
            <option value={cat} selected={categoryFilter === cat}>
              {cat.charAt(0).toUpperCase() + cat.slice(1)}
            </option>
          ))}
        </select>
      </div>

      <div class="filter-group">
        <label class="micro-label">City</label>
        <select id="city-filter">
          <option value="">All Cities</option>
          {cities.map(city => (
            <option value={city.slug} selected={cityFilter === city.slug}>
              {city.name}
            </option>
          ))}
        </select>
      </div>

      <div class="filter-group filter-group--search">
        <label class="micro-label">Search</label>
        <form method="GET" action="/events" class="search-form">
          <input
            type="search"
            name="q"
            placeholder="Search..."
            value={query || ''}
            autocomplete="off"
          >
        </form>
      </div>
    </div>

    {hasFilters && (
      <a href="/events" class="clear-filters">Clear all filters</a>
    )}
  </div>

  <!-- Events Grid -->
  <div class="events-grid">
    {events.map((event, i) => {
      const date = event.startDate ? formatDate(event.startDate) : null;
      return (
        <a href={`/events/${event.slug}`} class="event-card">
          <div class="event-card__image">
            {event.image ? (
              <img src={event.image} alt={event.title_en} loading="lazy" />
            ) : (
              <div class="event-card__placeholder"></div>
            )}
          </div>
          <div class="event-card__content">
            <div class="event-card__meta">
              {date && (
                <div class="event-card__date">
                  <span class="date-day">{date.day}</span>
                  <span class="date-month">{date.month}</span>
                </div>
              )}
              <span class="micro-label">{event.category}</span>
            </div>
            <h2>{event.title_en}</h2>
            <p class="event-card__location">{event.city}</p>
          </div>
        </a>
      );
    })}
  </div>

  {events.length === 0 && (
    <div class="no-results">
      <p>No events found matching your criteria.</p>
      <a href="/events" class="btn">View all events</a>
    </div>
  )}
</Base>

<script>
  const categorySelect = document.getElementById('category-filter') as HTMLSelectElement;
  const citySelect = document.getElementById('city-filter') as HTMLSelectElement;

  function applyFilters() {
    const params = new URLSearchParams(window.location.search);

    if (categorySelect?.value) params.set('category', categorySelect.value);
    else params.delete('category');

    if (citySelect?.value) params.set('city', citySelect.value);
    else params.delete('city');

    const queryString = params.toString();
    window.location.href = '/events' + (queryString ? '?' + queryString : '');
  }

  categorySelect?.addEventListener('change', applyFilters);
  citySelect?.addEventListener('change', applyFilters);
</script>

<style>
  .page-header {
    padding: var(--space-xl) 0 var(--space-lg);
    border-bottom: 1px solid var(--stone);
    margin-bottom: var(--space-lg);
  }

  .page-header .micro-label {
    display: block;
    margin-bottom: 0.5rem;
  }

  .page-header h1 {
    margin-bottom: 0.5rem;
  }

  .page-intro {
    color: var(--warm-gray);
    font-size: 0.9375rem;
  }

  /* Filters */
  .filters {
    margin-bottom: var(--space-xl);
  }

  .filter-row {
    display: flex;
    gap: var(--space-md);
    flex-wrap: wrap;
  }

  .filter-group {
    flex: 1;
    min-width: 160px;
  }

  .filter-group--search {
    flex: 2;
  }

  .filter-group .micro-label {
    display: block;
    margin-bottom: 0.5rem;
  }

  .filter-group select,
  .filter-group input {
    width: 100%;
    padding: 0.875rem 1rem;
    border: 1px solid var(--stone);
    background: var(--paper);
    color: var(--charcoal);
    font-family: var(--font-sans);
    font-size: 0.875rem;
    appearance: none;
    cursor: pointer;
    transition: border-color var(--duration-fast) var(--ease-out);
  }

  .filter-group select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%238A857D' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
  }

  .filter-group select:focus,
  .filter-group input:focus {
    outline: none;
    border-color: var(--ink);
  }

  .search-form {
    width: 100%;
  }

  .clear-filters {
    display: inline-block;
    margin-top: var(--space-sm);
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--terracotta);
    border-bottom: 1px solid transparent;
    transition: border-color var(--duration-fast) var(--ease-out);
  }

  .clear-filters:hover {
    border-color: var(--terracotta);
  }

  /* Events Grid */
  .events-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: var(--space-md);
  }

  .event-card {
    display: block;
    background: var(--paper);
    border: 1px solid var(--stone);
    transition: all var(--duration) var(--ease-out);
    overflow: hidden;
  }

  .event-card:hover {
    border-color: var(--ink);
    transform: translateY(-4px);
  }

  .event-card__image {
    aspect-ratio: 4/3;
    overflow: hidden;
    background: var(--stone);
  }

  .event-card__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform var(--duration) var(--ease-out);
  }

  .event-card:hover .event-card__image img {
    transform: scale(1.03);
  }

  .event-card__placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(145deg, var(--charcoal) 0%, var(--ink) 100%);
  }

  .event-card__content {
    padding: var(--space-md);
  }

  .event-card__meta {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    margin-bottom: var(--space-sm);
  }

  .event-card__date {
    text-align: center;
    line-height: 1;
  }

  .event-card__date .date-day {
    display: block;
    font-family: var(--font-serif);
    font-size: 1.5rem;
    color: var(--ink);
  }

  .event-card__date .date-month {
    font-size: 0.625rem;
    letter-spacing: 0.1em;
    color: var(--warm-gray);
  }

  .event-card h2 {
    font-size: 1.25rem;
    margin-bottom: 0.25rem;
    line-height: 1.3;
  }

  .event-card__location {
    font-size: 0.8125rem;
    color: var(--warm-gray);
  }

  /* No Results */
  .no-results {
    text-align: center;
    padding: var(--space-2xl) 0;
    color: var(--warm-gray);
  }

  .no-results .btn {
    margin-top: var(--space-md);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .events-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }

  @media (max-width: 768px) {
    .filter-row {
      flex-direction: column;
    }

    .filter-group {
      min-width: 100%;
    }

    .events-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
